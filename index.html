<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dossiê LSPD — Ferramenta de Investigação</title>

  <!--
  INSTRUÇÕES RÁPIDAS
  - Colar imagem: Clique no campo de "Link da Foto" e pressione Ctrl+V com a imagem no clipboard.
    O sistema converte para DataURL automaticamente e salva no campo e no preview.
  - Exportar/Importar JSON: Use os botões no topo. O arquivo JSON inclui todos os campos, listas e HTML do editor.
  - Tema Escuro: Clique no botão "Tema Escuro" para alternar. O PDF sempre sairá com tema claro.
  - Geração de PDF: Clique "Pré-visualizar PDF" para ver as páginas renderizadas e depois "Baixar PDF".
    O PDF é real e multi-página (jsPDF + html2canvas), com marca d'água CONFIDENCIAL, selo LSPD, cabeçalho e rodapé.
  - CORS e Imagens:
    * Preferimos DataURL (colando imagens ou quando o fetch consegue converter URL remota em DataURL).
    * Se fetch falhar por CORS, tentamos html2canvas com useCORS:true.
    * Se não for possível incorporar a imagem, usamos uma placeholder "Imagem indisponível".
  - Seções: É possível colapsar/expandir cada seção clicando no ícone do título.
  - Atalhos: Pressionar Enter nos campos adiciona veículos, conexões, evidências e timeline.
  - Salvamento: Tudo salva automaticamente no localStorage a cada alteração e recarrega ao abrir a página.

  MODO 100% OFFLINE (EMBUTIR LIBS)
  - Para usar totalmente offline (sem CDN):
    1) Baixe Quill, Font Awesome, jsPDF e html2canvas.
    2) Coloque seus conteúdos inline em <style> e <script> ou converta em DataURL base64.
    3) Substitua os links de CDN por blocos inline.
    4) Alternativa: crie uma flag embedLibs=true e carregue blocos inline condicionais.

  TROCAR O SELO LSPD
  - A logo do PDF foi atualizada com um PNG embutido em DataURL. Para trocar por outro,
    substitua a constante LSPD_SEAL_DATAURL por um dataURL PNG/JPEG.
  -->

  <!-- Font & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Quill -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root {
      --bg: #0f1216;
      --panel: #141923;
      --panel-2: #1a2130;
      --text: #e8edf5;
      --muted: #aab3c0;
      --accent: #4da3ff;
      --accent-2: #ff6b6b;
      --success: #44d19f;
      --border: #2a3342;
      --btn-primary: #4da3ff;
      --btn-alt: #6c7a92;
      --btn-ghost: transparent;
      --btn-text: #0b0e13;
      --shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    body.light {
      --bg: #f4f6fb;
      --panel: #ffffff;
      --panel-2: #f7f9fc;
      --text: #0b0e13;
      --muted: #51607a;
      --accent: #1f6feb;
      --accent-2: #c62828;
      --success: #2e7d32;
      --border: #d6deeb;
      --btn-primary: #1f6feb;
      --btn-alt: #48566b;
      --btn-ghost: transparent;
      --btn-text: #ffffff;
      --shadow: 0 6px 20px rgba(0,0,0,0.15);
    }

    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0;
    }

    .app {
      display: grid;
      grid-template-columns: 320px 1fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "topbar topbar"
        "sidebar main";
      height: 100vh;
    }
    .topbar {
      grid-area: topbar;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .title { display: flex; align-items: center; gap: 12px; font-weight: 700; letter-spacing: 0.5px; }
    .controls { display: flex; gap: 8px; align-items: center; }

    .sidebar {
      grid-area: sidebar;
      background: var(--panel);
      border-right: 1px solid var(--border);
      padding: 16px;
      overflow: auto;
    }
    .main {
      grid-area: main;
      padding: 16px;
      background: var(--panel-2);
      overflow: auto;
    }

    .section {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      overflow: hidden;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0));
    }
    .section-header h3 { font-size: 15px; margin: 0; font-weight: 700; letter-spacing: 0.3px; }
    .collapse-btn {
      border: none; background: var(--btn-ghost); color: var(--muted);
      cursor: pointer; padding: 6px 8px; border-radius: 8px;
    }
    .collapse-btn:hover { color: var(--text); background: rgba(255,255,255,0.06); }
    .section-body { padding: 14px; display: grid; gap: 12px; }
    .section.collapsed .section-body { display: none; }

    .field { display: grid; gap: 6px; }
    .field label { font-size: 12px; color: var(--muted); }
    input[type="text"], input[type="url"], select, textarea {
      background: var(--panel-2); color: var(--text); border: 1px solid var(--border);
      border-radius: 10px; padding: 10px 12px; outline: none; transition: border 0.2s, background 0.2s;
    }
    input::placeholder, textarea::placeholder { color: var(--muted); }
    input:focus, textarea:focus, select:focus { border-color: var(--accent); background: #0f1520; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-auto { display: flex; gap: 8px; flex-wrap: wrap; }
    .error { border-color: var(--accent-2) !important; }
    .error-msg { color: var(--accent-2); font-size: 12px; display:none; }

    .btn {
      border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px;
      cursor: pointer; font-weight: 600; font-size: 14px; transition: transform 0.02s, background 0.2s, color 0.2s, border 0.2s;
      display: inline-flex; align-items: center; gap: 8px;
    }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--btn-primary); color: var(--btn-text); border-color: transparent; }
    .btn-ghost { background: var(--btn-ghost); color: var(--text); }
    .btn-alt { background: var(--btn-alt); color: #fff; border-color: transparent; }
    .btn-danger { background: var(--accent-2); color: #fff; border-color: transparent; }

    .avatar {
      width: 120px; height: 120px; border-radius: 12px; overflow: hidden; border: 1px solid var(--border);
      display: grid; place-items: center; background: var(--panel-2);
    }
    .avatar img { width: 100%; height: 100%; object-fit: cover; }
    .thumb {
      width: 64px; height: 64px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border);
      background: var(--panel-2); display: grid; place-items: center;
    }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .thumb-placeholder { font-size: 10px; color: var(--muted); text-align: center; padding: 6px; }

    .list { display: grid; gap: 8px; }
    .list-item {
      display: flex; align-items: center; gap: 10px; background: var(--panel-2);
      border: 1px solid var(--border); border-radius: 10px; padding: 8px;
    }
    .item-content { flex: 1; display: grid; gap: 4px; }
    .item-actions { display: flex; gap: 6px; }

    .editor-container { background: var(--panel-2); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .ql-toolbar.ql-snow { background: var(--panel-2); border: none; border-bottom: 1px solid var(--border); color: var(--text); }
    .ql-container.ql-snow { border: none; background: #ffffff; color: #0b0e13; min-height: 220px; }

    .toast-container { position: fixed; bottom: 20px; right: 20px; display: grid; gap: 8px; z-index: 1000; }
    .toast {
      background: var(--panel); color: var(--text); border: 1px solid var(--border);
      border-left: 4px solid var(--success); padding: 10px 12px; border-radius: 10px; box-shadow: var(--shadow);
      font-size: 14px; opacity: 0; transform: translateY(10px); animation: toastIn 200ms ease forwards;
    }
    .toast.error { border-left-color: var(--accent-2); }
    @keyframes toastIn { to { opacity: 1; transform: translateY(0); } }

    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal.open { display: flex; }
    .modal-card {
      background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
      width: min(1000px, 92vw); max-height: 82vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow);
    }
    .modal-header, .modal-footer { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-header h4 { margin: 0; font-size: 16px; }
    .modal-body { padding: 12px; overflow: auto; display: grid; gap: 12px; background: var(--panel-2); }
    .preview-page { border: 1px dashed var(--border); background: #fff; padding: 6px; border-radius: 10px; }
    .preview-page img { width: 100%; display: block; background: #fff; }

    @media (max-width: 980px) {
      .app { grid-template-columns: 1fr; grid-template-areas: "topbar" "main"; }
      .sidebar { display: none; }
    }

    .print-root {
      position: fixed; top: -20000px; left: -20000px; width: 794px; background: #ffffff; color: #0b0e13; z-index: -1;
    }
    .print-header {
      display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 2px solid #e1e6f0;
    }
    .print-header-left { display: flex; align-items: center; gap: 12px; }
    .print-seal { width: 64px; height: 64px; border-radius: 8px; overflow: hidden; border: 1px solid #dbe3f1; display: grid; place-items: center; background: #fff; }
    .print-seal img { width: 100%; height: 100%; object-fit: cover; }
    .print-title { font-size: 18px; font-weight: 700; letter-spacing: 0.3px; }
    .print-subtitle { font-size: 12px; color: #455269; }
    .print-section { padding: 14px 16px; border-bottom: 1px solid #eef2f8; }
    .print-grid-2 { display: grid; grid-template-columns: 180px 1fr; gap: 16px; }
    .print-avatar { width: 180px; height: 180px; border-radius: 12px; overflow: hidden; border: 1px solid #dbe3f1; display: grid; place-items: center; background: #f9fbff; }
    .print-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .print-table th, .print-table td { border: 1px solid #dbe3f1; padding: 6px 8px; text-align: left; }
    .print-thumbs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .print-thumb { width: 100%; padding-top: 100%; position: relative; border: 1px solid #dbe3f1; border-radius: 10px; overflow: hidden; background: #f9fbff; }
    .print-thumb img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .print-evidences { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .print-evidence { border: 1px solid #dbe3f1; border-radius: 10px; overflow: hidden; background: #fff; }
    .print-evidence .img { width: 100%; padding-top: 100%; position: relative; background: #f9fbff; }
    .print-evidence .img img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .print-evidence .desc { padding: 8px; font-size: 12px; border-top: 1px solid #eef2f8; }
    .print-notes { font-size: 12px; line-height: 1.55; }
    .print-footer { padding: 10px 16px; border-top: 1px solid #eef2f8; font-size: 11px; color: #5a6883; }

    .print-root.watermark::before {
      content: "CONFIDENCIAL";
      position: fixed; top: 40%; left: 50%;
      transform: translate(-50%, -50%) rotate(-30deg);
      font-size: 120px; font-weight: 700; color: rgba(200,0,0,0.08);
      pointer-events: none; z-index: 0;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">
        <i class="fa-solid fa-shield-halved"></i>
        <span>Dossiê LSPD</span>
      </div>
      <div class="controls top-actions">
        <button id="toggleThemeBtn" class="btn btn-ghost"><i class="fa-solid fa-moon"></i> Tema escuro</button>
        <button id="exportJsonBtn" class="btn btn-alt"><i class="fa-solid fa-file-export"></i> Exportar Dossiê (JSON)</button>
        <label class="btn btn-ghost" style="position: relative; overflow: hidden;">
          <i class="fa-solid fa-file-import"></i> Importar Dossiê (JSON)
          <input id="importJsonInput" type="file" accept="application/json" style="position:absolute; inset:0; opacity:0; cursor:pointer;">
        </label>
        <button id="previewPdfBtn" class="btn btn-primary"><i class="fa-solid fa-file-pdf"></i> Pré-visualizar PDF</button>
      </div>
    </div>

    <aside class="sidebar">
      <div class="section">
        <div class="section-header">
          <h3>Dados do alvo</h3>
          <button class="collapse-btn" data-collapse="target"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-target">
          <div class="row">
            <div class="field">
              <label>Nome completo</label>
              <input id="alvoNome" type="text" placeholder="John Doe" />
              <div class="error-msg" data-error-for="alvoNome">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Apelido</label>
              <input id="alvoApelido" type="text" placeholder="JD / Wolf" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Endereço</label>
              <input id="alvoEndereco" type="text" placeholder="Rua, número, bairro, cidade" />
            </div>
            <div class="field">
              <label>Último visto</label>
              <input id="alvoUltimoVisto" type="text" placeholder="Data/local do último avistamento" />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Link da Foto do Alvo (URL ou Ctrl+V)</label>
              <input id="alvoFotoUrl" type="url" placeholder="https://..." />
              <div class="error-msg" data-error-for="alvoFotoUrl">URL inválida ou imagem indisponível.</div>
            </div>
            <div class="field">
              <label>Preview</label>
              <div class="avatar" id="alvoFotoPreview"><span class="thumb-placeholder">Sem imagem</span></div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label>Número do Caso</label>
              <input id="numeroCaso" type="text" placeholder="LSPD-2025-0001" />
              <div class="error-msg" data-error-for="numeroCaso">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Status da Investigação</label>
              <select id="statusInvestigacao">
                <option>Aberto</option>
                <option>Em Andamento</option>
                <option>Pausado</option>
                <option>Fechado</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label>Data de Criação do Relatório</label>
            <input id="dataCriacao" type="text" readonly />
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h3>Múltiplos veículos</h3>
          <button class="collapse-btn" data-collapse="vehicles"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-vehicles">
          <div class="row">
            <div class="field">
              <label>Placa</label>
              <input id="veiculoPlaca" type="text" placeholder="ABC-1234" />
              <div class="error-msg" data-error-for="veiculoPlaca">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Modelo</label>
              <input id="veiculoModelo" type="text" placeholder="Sedan Preto" />
              <div class="error-msg" data-error-for="veiculoModelo">Campo obrigatório.</div>
            </div>
          </div>
          <div class="row-auto">
            <button id="addVehicleBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Adicionar veículo</button>
          </div>
          <div class="list" id="vehiclesList"></div>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="section">
        <div class="section-header">
          <h3>Múltiplas conexões</h3>
          <button class="collapse-btn" data-collapse="connections"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-connections">
          <div class="row">
            <div class="field">
              <label>Nome da conexão</label>
              <input id="conexaoNome" type="text" placeholder="Jane Roe" />
              <div class="error-msg" data-error-for="conexaoNome">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Função (role)</label>
              <input id="conexaoFuncao" type="text" placeholder="Parceiro / Informante" />
              <div class="error-msg" data-error-for="conexaoFuncao">Campo obrigatório.</div>
            </div>
          </div>
          <div class="row">
            <div class="field">
              <label>Link da Foto (URL ou Ctrl+V)</label>
              <input id="conexaoFotoUrl" type="url" placeholder="https://..." />
            </div>
            <div class="field">
              <label>Preview</label>
              <div class="thumb" id="conexaoFotoPreview"><span class="thumb-placeholder">Sem imagem</span></div>
            </div>
          </div>
          <div class="row-auto">
            <button id="addConnectionBtn" class="btn btn-primary"><i class="fa-solid fa-user-plus"></i> Adicionar conexão</button>
          </div>
          <div class="list" id="connectionsList"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h3>Múltiplas evidências</h3>
          <button class="collapse-btn" data-collapse="evidences"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-evidences">
          <div class="row">
            <div class="field">
              <label>Descrição da evidência</label>
              <input id="evidenciaDescricao" type="text" placeholder="Foto do alvo entrando no veículo..." />
              <div class="error-msg" data-error-for="evidenciaDescricao">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Link da Foto/Evidência (URL ou Ctrl+V)</label>
              <input id="evidenciaFotoUrl" type="url" placeholder="https://..." />
            </div>
          </div>
          <div class="row-auto">
            <button id="addEvidenceBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Adicionar evidência</button>
          </div>
          <div class="list" id="evidencesList"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h3>Timeline / ações</h3>
          <button class="collapse-btn" data-collapse="timeline"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-timeline">
          <div class="row">
            <div class="field">
              <label>Data/Hora</label>
              <input id="timelineDataHora" type="text" placeholder="27/09/2025 12:34" />
              <div class="error-msg" data-error-for="timelineDataHora">Campo obrigatório.</div>
            </div>
            <div class="field">
              <label>Ação</label>
              <input id="timelineAcao" type="text" placeholder="Alvo observado na Av. ..." />
              <div class="error-msg" data-error-for="timelineAcao">Campo obrigatório.</div>
            </div>
          </div>
          <div class="row-auto">
            <button id="addTimelineBtn" class="btn btn-primary"><i class="fa-solid fa-plus"></i> Adicionar linha</button>
          </div>
          <div class="list" id="timelineList"></div>
        </div>
      </div>

      <div class="section">
        <div class="section-header">
          <h3>Notas do detetive / editor</h3>
          <button class="collapse-btn" data-collapse="editor"><i class="fa-solid fa-chevron-up"></i></button>
        </div>
        <div class="section-body" id="section-editor">
          <div class="editor-container">
            <div id="editorToolbar">
              <span class="ql-formats">
                <select class="ql-size">
                  <option value="small"></option>
                  <option selected></option>
                  <option value="large"></option>
                </select>
              </span>
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
            </div>
            <div id="editorArea"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toasts -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Modal de pré-visualização -->
  <div class="modal" id="previewModal">
    <div class="modal-card">
      <div class="modal-header">
        <h4>Pré-visualização do PDF</h4>
        <button class="btn btn-ghost" id="closePreviewBtn"><i class="fa-solid fa-xmark"></i> Fechar</button>
      </div>
      <div class="modal-body" id="previewPagesContainer"></div>
      <div class="modal-footer">
        <div style="display:flex; gap:8px;">
          <button class="btn btn-primary" id="downloadPdfBtn"><i class="fa-solid fa-download"></i> Baixar PDF</button>
          <button class="btn btn-ghost" id="rebuildPreviewBtn"><i class="fa-solid fa-rotate-right"></i> Regerar prévia</button>
        </div>
        <div style="color:var(--muted); font-size:12px;">PDF usa tema claro e inclui marca d'água, selo e numeração.</div>
      </div>
    </div>
  </div>

  <!-- Offscreen print-friendly root -->
  <div class="print-root watermark" id="printRoot" aria-hidden="true"></div>

  <!-- Quill -->
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <script>
    // =========================
    // Constantes e utilidades
    // =========================

    const STORAGE_KEY = 'lspd_dossie_v1';

    // Selo LSPD em PNG DataURL (substitua por outro dataURL PNG/JPEG se desejar)
    // Este é um PNG simples com fundo azul e letras LSPD, apenas para fins de exemplo.
    const LSPD_SEAL_DATAURL = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAACXBIWXMAAAsSAAALEgHS3X78AAABcUlEQVR4nO2ZMU7DQBCEv+oFQHkS7kBEcCkS3kB0Qm2m6u1DqR3yq3Nw5Jq0KpQQ5Q6b8bFQxX5b0bFtvJ4fQ3Vn8iXG1O3rjz8i5kQmVQmS3Sdwgq9jQkq0btYp3p8S3G2HqfBfG8xg2g6vY5vI0i5g7wR8I4b2MsnW9iD1JvJ2Kk6yqIu8pM8yCqQqTqHh3mR4aYV3wCwQd3p7Qe8L9GJfQvG6Wm4CkH8lQJc5Q6b5wYyJfomjvKfQWfJv6QH0qk3QeGqg7D3P8rH8b3mJ8j7Qv8Q0mQmQ2t6YwE3Vf9rO1xK3mQW8zW8r5lG3wJbCN+G3Ih5zv8qA2P4cY0c9LJHk1M3JZkAqCw2pS0Q6uDqPj1m7Xl3o5oYwHeZ4HfV3m3mJco2kEo7V6oKkCj1KpRqgqkKoKpAqgqlJkMqzH9FfH2nD9l3z4m3uF8vB6jH1p3B3kCkCkCkCkCkCkCkCkCkCkCkCkCkKkH8B6lqNf0b3E0AAAAAElFTkSuQmCC';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function toast(msg, type='success') {
      const cont = $('#toastContainer');
      const el = document.createElement('div');
      el.className = 'toast' + (type === 'error' ? ' error' : '');
      el.textContent = msg;
      cont.appendChild(el);
      setTimeout(() => {
        el.style.transition = 'opacity 200ms ease, transform 200ms ease';
        el.style.opacity = '0';
        el.style.transform = 'translateY(10px)';
        setTimeout(() => el.remove(), 220);
      }, 2400);
    }

    function validateRequired(inputEl) {
      const ok = !!inputEl.value.trim();
      const em = document.querySelector('.error-msg[data-error-for="' + inputEl.id + '"]');
      if (!ok) { inputEl.classList.add('error'); if (em) em.style.display = 'block'; }
      else { inputEl.classList.remove('error'); if (em) em.style.display = 'none'; }
      return ok;
    }

    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob);
      });
    }

    async function tryFetchToDataURL(url) {
      try {
        const resp = await fetch(url, { mode: 'cors' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const blob = await resp.blob();
        return await blobToDataURL(blob);
      } catch (e) {
        console.warn('Falha ao converter URL em DataURL (CORS?):', e);
        return null;
      }
    }

    function setSquareImage(containerEl, dataUrl) {
      containerEl.innerHTML = '';
      const img = document.createElement('img');
      img.src = dataUrl;
      containerEl.appendChild(img);
    }

    function setPlaceholder(containerEl, message='Imagem indisponível') {
      containerEl.innerHTML = '';
      const span = document.createElement('span');
      span.className = 'thumb-placeholder';
      span.textContent = message;
      containerEl.appendChild(span);
    }

    async function handlePasteImageToInput(e, previewEl) {
      const cd = e.clipboardData || (e.originalEvent && e.originalEvent.clipboardData);
      if (!cd || !cd.items) return;
      for (const item of cd.items) {
        if (item.kind === 'file') {
          const file = item.getAsFile();
          if (file && file.type.startsWith('image/')) {
            const dataUrl = await blobToDataURL(file);
            e.target.value = dataUrl;
            if (previewEl) setSquareImage(previewEl, dataUrl);
            updateStateFromUI();
            saveData();
            toast('Imagem colada');
            e.preventDefault();
            return;
          }
        }
      }
    }

    // =========================
    // Estado do dossiê
    // =========================

    const state = {
      alvo: {
        nome: '',
        apelido: '',
        endereco: '',
        ultimoVisto: '',
        foto: '',
        numeroCaso: '',
        status: 'Aberto',
        dataCriacao: ''
      },
      veiculos: [],
      conexoes: [],
      evidencias: [],
      timeline: [],
      notasHtml: ''
    };

    // =========================
    // Editor (Quill)
    // =========================
    let quill;

    function initEditor() {
      quill = new Quill('#editorArea', {
        modules: { toolbar: '#editorToolbar' },
        theme: 'snow'
      });
      quill.on('text-change', () => {
        const editorEl = document.querySelector('#editorArea .ql-editor');
        state.notasHtml = editorEl.innerHTML;
        saveData();
      });
    }

    // =========================
    // Autosave de todos inputs
    // =========================

    function bindAutoSave() {
      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.addEventListener('input', () => { updateStateFromUI(); saveData(); });
        el.addEventListener('change', () => { updateStateFromUI(); saveData(); });
      });
    }

    function updateStateFromUI() {
      state.alvo.nome = $('#alvoNome').value;
      state.alvo.apelido = $('#alvoApelido').value;
      state.alvo.endereco = $('#alvoEndereco').value;
      state.alvo.ultimoVisto = $('#alvoUltimoVisto').value;
      state.alvo.foto = $('#alvoFotoUrl').value;
      state.alvo.numeroCaso = $('#numeroCaso').value;
      state.alvo.status = $('#statusInvestigacao').value;
      state.alvo.dataCriacao = $('#dataCriacao').value;

      const editorEl = document.querySelector('#editorArea .ql-editor');
      if (editorEl) state.notasHtml = editorEl.innerHTML;
    }

    // =========================
    // Inicialização geral
    // =========================

    function initUI() {
      // Preenche data de criação se vazio
      const dataStr = new Date().toLocaleString('pt-BR');
      $('#dataCriacao').value = state.alvo.dataCriacao || dataStr;
      if (!state.alvo.dataCriacao) state.alvo.dataCriacao = $('#dataCriacao').value;

      // Collapse
      $$('.collapse-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const target = btn.getAttribute('data-collapse');
          const section = document.querySelector('#section-' + target);
          if (!section) return;
          const parent = section.closest('.section');
          parent.classList.toggle('collapsed');
          btn.innerHTML = parent.classList.contains('collapsed')
            ? '<i class="fa-solid fa-chevron-down"></i>'
            : '<i class="fa-solid fa-chevron-up"></i>';
        });
      });

      // Tema
      $('#toggleThemeBtn').addEventListener('click', () => {
        document.body.classList.toggle('light');
        $('#toggleThemeBtn').innerHTML = document.body.classList.contains('light')
          ? '<i class="fa-solid fa-sun"></i> Tema claro'
          : '<i class="fa-solid fa-moon"></i> Tema escuro';
      });

      // Inputs alvo
      $('#alvoNome').addEventListener('input', () => { validateRequired($('#alvoNome')); });
      $('#numeroCaso').addEventListener('input', () => { validateRequired($('#numeroCaso')); });

      // Foto do alvo
      $('#alvoFotoUrl').addEventListener('input', async (e) => {
        const url = e.target.value.trim();
        if (!url) { state.alvo.foto = ''; setPlaceholder($('#alvoFotoPreview')); saveData(); return; }
        let dataUrl = null;
        if (url.startsWith('data:image/')) dataUrl = url;
        else dataUrl = await tryFetchToDataURL(url);
        if (dataUrl) {
          state.alvo.foto = dataUrl;
          setSquareImage($('#alvoFotoPreview'), dataUrl);
          toast('Foto do alvo atualizada');
        } else {
          state.alvo.foto = url; // manter URL para fallback
          setPlaceholder($('#alvoFotoPreview'), 'Imagem remota (tentaremos incorporar)');
        }
        saveData();
      });
      $('#alvoFotoUrl').addEventListener('paste', (e) => handlePasteImageToInput(e, $('#alvoFotoPreview')));

      // Veículos
      $('#addVehicleBtn').addEventListener('click', addVehicle);
      $('#veiculoPlaca').addEventListener('keydown', (e) => { if (e.key === 'Enter') addVehicle(); });
      $('#veiculoModelo').addEventListener('keydown', (e) => { if (e.key === 'Enter') addVehicle(); });

      // Conexões
      $('#addConnectionBtn').addEventListener('click', addConnection);
      $('#conexaoNome').addEventListener('keydown', (e) => { if (e.key === 'Enter') addConnection(); });
      $('#conexaoFuncao').addEventListener('keydown', (e) => { if (e.key === 'Enter') addConnection(); });
      $('#conexaoFotoUrl').addEventListener('keydown', (e) => { if (e.key === 'Enter') addConnection(); });

      $('#conexaoFotoUrl').addEventListener('input', async (e) => {
        const url = e.target.value.trim();
        if (!url) { setPlaceholder($('#conexaoFotoPreview')); return; }
        let dataUrl = null;
        if (url.startsWith('data:image/')) dataUrl = url;
        else dataUrl = await tryFetchToDataURL(url);
        if (dataUrl) setSquareImage($('#conexaoFotoPreview'), dataUrl);
        else setPlaceholder($('#conexaoFotoPreview'), 'Imagem remota (tentaremos incorporar)');
      });
      $('#conexaoFotoUrl').addEventListener('paste', (e) => handlePasteImageToInput(e, $('#conexaoFotoPreview')));

      // Evidências
      $('#addEvidenceBtn').addEventListener('click', addEvidence);
      $('#evidenciaDescricao').addEventListener('keydown', (e) => { if (e.key === 'Enter') addEvidence(); });
      $('#evidenciaFotoUrl').addEventListener('keydown', (e) => { if (e.key === 'Enter') addEvidence(); });
      $('#evidenciaFotoUrl').addEventListener('paste', (e) => handlePasteImageToInput(e, null));

      // Timeline
      $('#addTimelineBtn').addEventListener('click', addTimeline);
      $('#timelineDataHora').addEventListener('keydown', (e) => { if (e.key === 'Enter') addTimeline(); });
      $('#timelineAcao').addEventListener('keydown', (e) => { if (e.key === 'Enter') addTimeline(); });

      // Export / Import
      $('#exportJsonBtn').addEventListener('click', exportJson);
      $('#importJsonInput').addEventListener('change', importJson);

      // Preview / Download
      $('#previewPdfBtn').addEventListener('click', buildPreviewModal);
      $('#closePreviewBtn').addEventListener('click', () => $('#previewModal').classList.remove('open'));
      $('#rebuildPreviewBtn').addEventListener('click', buildPreviewModal);
      $('#downloadPdfBtn').addEventListener('click', downloadPdfConfirmed);
    }

    // =========================
    // Veículos
    // =========================

    function addVehicle() {
      const placaEl = $('#veiculoPlaca');
      const modeloEl = $('#veiculoModelo');
      const validPlaca = validateRequired(placaEl);
      const validModelo = validateRequired(modeloEl);
      if (!validPlaca || !validModelo) { toast('Preencha placa e modelo', 'error'); return; }
      const item = { placa: placaEl.value.trim(), modelo: modeloEl.value.trim() };
      state.veiculos.push(item);
      renderVehicles();
      placaEl.value = ''; modeloEl.value = '';
      saveData();
      toast('Veículo adicionado');
    }

    function renderVehicles() {
      const list = $('#vehiclesList');
      list.innerHTML = '';
      state.veiculos.forEach((v, idx) => {
        const li = document.createElement('div');
        li.className = 'list-item';
        li.innerHTML = `
          <div class="item-content">
            <div><strong>${v.placa}</strong></div>
            <div style="color:var(--muted); font-size:12px;">${v.modelo}</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost btn-remove"><i class="fa-solid fa-trash"></i> Remover</button>
          </div>
        `;
        li.querySelector('.btn-remove').addEventListener('click', function() {
          state.veiculos.splice(idx, 1);
          this.parentElement.parentElement.remove();
          saveData();
          renderVehicles();
          toast('Veículo removido');
        });
        list.appendChild(li);
      });
    }

    // =========================
    // Conexões
    // =========================

    async function addConnection() {
      const nomeEl = $('#conexaoNome');
      const funcaoEl = $('#conexaoFuncao');
      const fotoEl = $('#conexaoFotoUrl');
      const vNome = validateRequired(nomeEl);
      const vFuncao = validateRequired(funcaoEl);
      if (!vNome || !vFuncao) { toast('Preencha nome e função da conexão', 'error'); return; }

      let foto = fotoEl.value.trim();
      if (foto && !foto.startsWith('data:image/')) {
        const dataUrl = await tryFetchToDataURL(foto);
        if (dataUrl) foto = dataUrl;
      }

      const item = { nome: nomeEl.value.trim(), funcao: funcaoEl.value.trim(), foto };
      state.conexoes.push(item);
      renderConnections();
      nomeEl.value = '';
      funcaoEl.value = '';
      fotoEl.value = '';
      setPlaceholder($('#conexaoFotoPreview'));
      saveData();
      toast('Conexão adicionada');
    }

    function renderConnections() {
      const list = $('#connectionsList');
      list.innerHTML = '';
      state.conexoes.forEach((c, idx) => {
        const li = document.createElement('div');
        li.className = 'list-item';
        const thumbHtml = c.foto
          ? `<div class="thumb"><img src="${c.foto}" /></div>`
          : `<div class="thumb"><span class="thumb-placeholder">Sem imagem</span></div>`;
        li.innerHTML = `
          ${thumbHtml}
          <div class="item-content">
            <div><strong>${c.nome}</strong> <span style="color:var(--muted); font-size:12px;">(${c.funcao})</span></div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost btn-remove"><i class="fa-solid fa-trash"></i> Remover</button>
          </div>
        `;
        li.querySelector('.btn-remove').addEventListener('click', function() {
          state.conexoes.splice(idx, 1);
          this.parentElement.parentElement.remove();
          saveData();
          renderConnections();
          toast('Conexão removida');
        });
        list.appendChild(li);
      });
    }

    // =========================
    // Evidências
    // =========================

    async function addEvidence() {
      const descEl = $('#evidenciaDescricao');
      const fotoEl = $('#evidenciaFotoUrl');
      const vDesc = validateRequired(descEl);
      if (!vDesc) { toast('Descrição é obrigatória', 'error'); return; }

      let foto = fotoEl.value.trim();
      if (foto && !foto.startsWith('data:image/')) {
        const dataUrl = await tryFetchToDataURL(foto);
        if (dataUrl) foto = dataUrl;
      }
      const item = { descricao: descEl.value.trim(), foto };
      state.evidencias.push(item);
      renderEvidences();
      descEl.value = '';
      fotoEl.value = '';
      saveData();
      toast('Evidência adicionada');
    }

    function renderEvidences() {
      const list = $('#evidencesList');
      list.innerHTML = '';
      state.evidencias.forEach((evi, idx) => {
        const li = document.createElement('div');
        li.className = 'list-item';
        const thumbHtml = evi.foto
          ? `<div class="thumb"><img src="${evi.foto}" /></div>`
          : `<div class="thumb"><span class="thumb-placeholder">Sem imagem</span></div>`;
        li.innerHTML = `
          ${thumbHtml}
          <div class="item-content">
            <div><strong>${evi.descricao}</strong></div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost btn-remove"><i class="fa-solid fa-trash"></i> Remover</button>
          </div>
        `;
        li.querySelector('.btn-remove').addEventListener('click', function() {
          state.evidencias.splice(idx, 1);
          this.parentElement.parentElement.remove();
          saveData();
          renderEvidences();
          toast('Evidência removida');
        });
        list.appendChild(li);
      });
    }

    // =========================
    // Timeline
    // =========================

    function addTimeline() {
      const dataEl = $('#timelineDataHora');
      const acaoEl = $('#timelineAcao');
      const vData = validateRequired(dataEl);
      const vAcao = validateRequired(acaoEl);
      if (!vData || !vAcao) { toast('Preencha data/hora e ação', 'error'); return; }

      const item = { dataHora: dataEl.value.trim(), acao: acaoEl.value.trim() };
      state.timeline.push(item);
      renderTimeline();
      dataEl.value = '';
      acaoEl.value = '';
      saveData();
      toast('Linha adicionada');
    }

    function renderTimeline() {
      const list = $('#timelineList');
      list.innerHTML = '';
      state.timeline.forEach((t, idx) => {
        const li = document.createElement('div');
        li.className = 'list-item';
        li.innerHTML = `
          <div class="item-content">
            <div><strong>${t.dataHora}</strong></div>
            <div style="color:var(--muted); font-size:12px;">${t.acao}</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-ghost btn-remove"><i class="fa-solid fa-trash"></i> Remover</button>
          </div>
        `;
        li.querySelector('.btn-remove').addEventListener('click', function() {
          state.timeline.splice(idx, 1);
          this.parentElement.parentElement.remove();
          saveData();
          renderTimeline();
          toast('Linha removida');
        });
        list.appendChild(li);
      });
    }

    // =========================
    // Salvamento Local
    // =========================

    function saveData() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn('Falha ao salvar localmente', e);
      }
    }

    function loadData() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        const data = JSON.parse(raw);

        // Merge seguro
        state.alvo = { ...state.alvo, ...(data.alvo || {}) };
        state.veiculos = Array.isArray(data.veiculos) ? data.veiculos : [];
        state.conexoes = Array.isArray(data.conexoes) ? data.conexoes : [];
        state.evidencias = Array.isArray(data.evidencias) ? data.evidencias : [];
        state.timeline = Array.isArray(data.timeline) ? data.timeline : [];
        state.notasHtml = data.notasHtml || '';

        // Repopular UI
        $('#alvoNome').value = state.alvo.nome || '';
        $('#alvoApelido').value = state.alvo.apelido || '';
        $('#alvoEndereco').value = state.alvo.endereco || '';
        $('#alvoUltimoVisto').value = state.alvo.ultimoVisto || '';
        $('#alvoFotoUrl').value = state.alvo.foto || '';
        $('#numeroCaso').value = state.alvo.numeroCaso || '';
        $('#statusInvestigacao').value = state.alvo.status || 'Aberto';
        $('#dataCriacao').value = state.alvo.dataCriacao || new Date().toLocaleString('pt-BR');

        if (state.alvo.foto) setSquareImage($('#alvoFotoPreview'), state.alvo.foto);
        else setPlaceholder($('#alvoFotoPreview'));

        renderVehicles();
        renderConnections();
        renderEvidences();
        renderTimeline();

        if (state.notasHtml) {
          const editorEl = document.querySelector('#editorArea .ql-editor');
          if (editorEl) editorEl.innerHTML = state.notasHtml;
        }

        toast('Dossiê carregado');
      } catch (e) {
        console.warn('Falha ao carregar dados', e);
      }
    }

    // =========================
    // Exportar / Importar JSON
    // =========================

    function exportJson() {
      try {
        const dataStr = JSON.stringify(state, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const num = state.alvo.numeroCaso ? state.alvo.numeroCaso.replace(/\s+/g,'_') : 'sem-numero';
        a.download = `dossie_lspd_${num}.json`;
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        toast('JSON exportado');
      } catch (e) {
        toast('Falha ao exportar JSON', 'error');
      }
    }

    function importJson(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          // Substitui estado completamente por importado
          state.alvo = data.alvo || state.alvo;
          state.veiculos = Array.isArray(data.veiculos) ? data.veiculos : [];
          state.conexoes = Array.isArray(data.conexoes) ? data.conexoes : [];
          state.evidencias = Array.isArray(data.evidencias) ? data.evidencias : [];
          state.timeline = Array.isArray(data.timeline) ? data.timeline : [];
          state.notasHtml = data.notasHtml || '';

          saveData();
          loadData();
          toast('JSON importado');
        } catch (err) {
          toast('Falha ao importar JSON', 'error');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    }

    // =========================
    // Print HTML (tema claro offscreen)
    // =========================

    function buildPrintHTML() {
      const root = $('#printRoot');
      root.innerHTML = '';

      const header = document.createElement('div');
      header.className = 'print-header';
      header.innerHTML = `
        <div class="print-header-left">
          <div class="print-seal"><img src="${LSPD_SEAL_DATAURL}" /></div>
          <div>
            <div class="print-title">Departamento de Polícia de Los Santos</div>
            <div class="print-subtitle">Relatório de Investigação — Caso ${state.alvo.numeroCaso || 'N/D'}</div>
          </div>
        </div>
        <div class="print-header-right">
          <div class="print-subtitle">Status: ${state.alvo.status}</div>
          <div class="print-subtitle">Criado: ${state.alvo.dataCriacao}</div>
        </div>
      `;
      root.appendChild(header);

      const fotoAlvo = state.alvo.foto;
      const alvoImgHtml = fotoAlvo && fotoAlvo.startsWith('data:image/')
        ? `<img src="${fotoAlvo}" />`
        : (fotoAlvo ? `<img src="${fotoAlvo}" crossorigin="anonymous" />`
                    : '<div class="thumb-placeholder" style="font-size:12px;">Sem imagem</div>');

      const secAlvo = document.createElement('div');
      secAlvo.className = 'print-section';
      secAlvo.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Alvo</h3>
        <div class="print-grid-2">
          <div class="print-avatar">
            ${alvoImgHtml}
          </div>
          <div>
            <div><strong>Nome:</strong> ${state.alvo.nome || '—'}</div>
            <div><strong>Apelido:</strong> ${state.alvo.apelido || '—'}</div>
            <div><strong>Endereço:</strong> ${state.alvo.endereco || '—'}</div>
            <div><strong>Último visto:</strong> ${state.alvo.ultimoVisto || '—'}</div>
            <div style="margin-top:8px;"><strong>Nº Caso:</strong> ${state.alvo.numeroCaso || '—'}</div>
          </div>
        </div>
      `;
      root.appendChild(secAlvo);

      const secVeic = document.createElement('div');
      secVeic.className = 'print-section';
      secVeic.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Veículos</h3>
        <table class="print-table">
          <thead>
            <tr><th>Placa</th><th>Modelo</th></tr>
          </thead>
          <tbody>
            ${state.veiculos.length ? state.veiculos.map(v => `<tr><td>${v.placa}</td><td>${v.modelo}</td></tr>`).join('') : '<tr><td colspan="2">Nenhum veículo</td></tr>'}
          </tbody>
        </table>
      `;
      root.appendChild(secVeic);

      const secCon = document.createElement('div');
      secCon.className = 'print-section';
      secCon.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Conexões</h3>
        <div class="print-thumbs">
          ${state.conexoes.length ? state.conexoes.map(c => `
            <div>
              <div class="print-thumb">
                ${c.foto ? (c.foto.startsWith('data:image/') ? `<img src="${c.foto}" />` : `<img src="${c.foto}" crossorigin="anonymous" />`) : ''}
              </div>
              <div style="font-size:12px; margin-top:6px;"><strong>${c.nome}</strong><br/><span style="color:#5a6883">${c.funcao}</span></div>
            </div>
          `).join('') : '<div style="font-size:12px; color:#5a6883;">Nenhuma conexão</div>'}
        </div>
      `;
      root.appendChild(secCon);

      const secEvi = document.createElement('div');
      secEvi.className = 'print-section';
      secEvi.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Evidências</h3>
        <div class="print-evidences">
          ${state.evidencias.length ? state.evidencias.map(e => `
            <div class="print-evidence">
              <div class="img">
                ${e.foto ? (e.foto.startsWith('data:image/') ? `<img src="${e.foto}" />` : `<img src="${e.foto}" crossorigin="anonymous" />`) : ''}
              </div>
              <div class="desc">${e.descricao}</div>
            </div>
          `).join('') : '<div style="font-size:12px; color:#5a6883;">Nenhuma evidência</div>'}
        </div>
      `;
      root.appendChild(secEvi);

      const secTime = document.createElement('div');
      secTime.className = 'print-section';
      secTime.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Timeline</h3>
        <table class="print-table">
          <thead><tr><th>Data/Hora</th><th>Ação</th></tr></thead>
          <tbody>
            ${state.timeline.length ? state.timeline.map(t => `<tr><td>${t.dataHora}</td><td>${t.acao}</td></tr>`).join('') : '<tr><td colspan="2">Nenhuma linha</td></tr>'}
          </tbody>
        </table>
      `;
      root.appendChild(secTime);

      const secNotas = document.createElement('div');
      secNotas.className = 'print-section';
      secNotas.innerHTML = `
        <h3 style="margin:0 0 8px 0; font-size:14px;">Notas do detetive</h3>
        <div class="print-notes">${state.notasHtml || '<span style="color:#5a6883;">Sem notas</span>'}</div>
      `;
      root.appendChild(secNotas);

      const footer = document.createElement('div');
      footer.className = 'print-footer';
      footer.textContent = 'Departamento de Polícia de Los Santos — Relatório confidencial.';
      root.appendChild(footer);
    }

    // =========================
    // Pré-visualização (html2canvas em páginas)
    // =========================

    async function buildPreviewModal() {
      const okNome = validateRequired($('#alvoNome'));
      const okCaso = validateRequired($('#numeroCaso'));
      if (!okNome || !okCaso) {
        toast('Preencha os campos obrigatórios antes de gerar PDF', 'error');
        return;
      }

      buildPrintHTML();
      const root = $('#printRoot');

      const canvas = await html2canvas(root, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true
      });

      const pages = sliceCanvasIntoA4Pages(canvas);
      const cont = $('#previewPagesContainer');
      cont.innerHTML = '';
      pages.forEach(p => {
        const div = document.createElement('div');
        div.className = 'preview-page';
        const img = document.createElement('img');
        img.src = p.toDataURL('image/png');
        div.appendChild(img);
        cont.appendChild(div);
      });

      $('#previewModal').classList.add('open');
      toast('Prévia gerada');
    }

    function sliceCanvasIntoA4Pages(canvas) {
      const a4w = 794 * 2;
      const a4h = 1123 * 2;
      const pages = [];
      let offsetY = 0;
      while (offsetY < canvas.height) {
        const pageCanvas = document.createElement('canvas');
        pageCanvas.width = a4w;
        pageCanvas.height = a4h;
        const ctx = pageCanvas.getContext('2d');
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, a4w, a4h);
        ctx.drawImage(canvas, 0, offsetY, a4w, a4h, 0, 0, a4w, a4h);
        pages.push(pageCanvas);
        offsetY += a4h;
      }
      return pages;
    }

    // =========================
    // Download do PDF (jsPDF)
    // =========================

    async function downloadPdfConfirmed() {
      const root = $('#printRoot');
      const canvas = await html2canvas(root, {
        backgroundColor: '#ffffff',
        scale: 2,
        useCORS: true
      });
      const pages = sliceCanvasIntoA4Pages(canvas);

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('p', 'mm', 'a4');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();

      for (let i = 0; i < pages.length; i++) {
        if (i > 0) doc.addPage();
        const imgData = pages[i].toDataURL('image/png');
        doc.addImage(imgData, 'PNG', 0, 0, pageWidth, pageHeight);

        doc.setTextColor(90);
        doc.setFontSize(9);
        doc.text(`Página ${i+1} de ${pages.length}`, pageWidth - 30, pageHeight - 6);

        doc.setTextColor(230, 200, 200);
        doc.setFontSize(48);
        doc.saveGraphicsState();
        doc.setGState(new doc.GState({ opacity: 0.08 }));
        doc.text('CONFIDENCIAL', pageWidth/2, pageHeight/2, { angle: -30, align: 'center' });
        doc.restoreGraphicsState();
      }

      const num = state.alvo.numeroCaso ? state.alvo.numeroCaso.replace(/\s+/g,'_') : 'sem-numero';
      doc.save(`dossie_lspd_${num}.pdf`);
      toast('PDF baixado');
      $('#previewModal').classList.remove('open');
    }

    // =========================
    // Boot
    // =========================

    document.addEventListener('DOMContentLoaded', () => {
      initEditor();
      initUI();
      loadData();
      bindAutoSave();
    });
  </script>
</body>
</html>
